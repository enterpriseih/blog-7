





### 全量复制流程（初次建立主从关系触发）

#### 从节点

1. 从节点发送psync命令
2. 接收主机点的runID和offset
3. 接收到主节点发送的RDB文件后清空本地文件，加载RDB文件
4. 若开启AOF，调用命令bgrewriteaof生成AOF文件

![image-20210129152438579](C:\Users\28299\AppData\Roaming\Typora\typora-user-images\image-20210129152438579.png)

#### 主节点

1. 主节点调用bgsave生成RDB文件
2. 如果生成RDB较大， 传输耗时超过配置文件repl-timeout配置时间将造成全量复制失败
3. 无盘复制：生成的RDB文件不保存硬盘直接通过网络发送从节点，适用网络环境较好，但是硬盘性能差。repl-diskless-sync参数控制
4. 在传输RDB和从节点加载完成RDB文件过程中，新写入的命令保存在复制客户端缓冲区内，网络环境过差会造成缓冲区溢出，复制失败。client-output-buffer-limit slave，从节点加载完成RDB，主节点将缓冲区内数据发送到从节点。

![image-20210129152747860](C:\Users\28299\AppData\Roaming\Typora\typora-user-images\image-20210129152747860.png)

#### 全量复制中时间开销

1. 生成RDB文件，bgsave时间
2. 传输RDB文件
3. 从节点清空本地数据时间
4. 从节点加载RDB文件时间
5. 从节点生成AOF文件时间



### 部分复制（从节点网络故障造成从节点故障时间数据丢失）

- 从节点保存offset
- 主节点将网络故障阶段数据保存在复制积压缓冲区
- 网络恢复后从节点将保存的runid和offset发送给主节点，主节点在复制积压缓冲区中找到对应的offset后回复从节点continue命令，进行部分复制



### 主从复制可能出现的问题

#### 主节点响应完成写命令后直接返回给客户端，命令同步给从节点是异步的，所以主从节点数据延时是无法避免的，应该尽量主从节点布置在同一机房，避免网络原因造成延迟过大

- 在主机点使用info replication，其中的slava0中的offset（从节点偏移量）和master_repli_offset(主节点偏移量)只差就是延迟的字节量
- 在对延时敏感的业务场景中尽量使用redis集群做水平扩展

#### 主从配置不一样

- 对于内存相关的配置必须一样

#### 复制风暴

- 单主节点复制风暴，使用树状结构降低主节点全量复制对象
- 单主机复制风暴，尽量不要一个主机部署多个redis服务。

